========================================= HOMEWORK 11 ====================================
Основное ДЗ Vagrant:

- Установили Vagrant и virtualbox, добавили служебные файлы в .gitignore;
- Создали описание локальной инфраструктуры в виде vagrantfile;
- С помощью vagrant up развернули две виртуалки - app и db;
- Проверили, что инстансы подняты и доступны;
- Запустили ансибл - провижионер через vagrant, получили ошибку,
  что пайтон не установлен;
- Добавили playbook для установки Пайтона на всех хостах;
- Теперь Ansible не смог найт монго; Добавили таски
  по установке и настройке Монго в роль db;
- Через telnet проверили, что БД доступна на внешнем порут 27017;
- Аналогичным образом добавили таски для роли app и развернули приложение;
- Доработали все роли в соответствии с локальным окружением, в extra-vars использовали
  пользователя vagrant;
- Удалили и пересоздали ВМ - приложение запускается, подключение к базе есть;

ДЗ*

- 
========================================= HOMEWORK 10 ====================================

Основное ДЗ:

- Познакомились с ролями в Ansible;
- Создали структуру в формате ansible - galaxy и перенесли туда таски из плейбуков;
- Навели порядок в директории Ansible согласно best parctices;
- Протестировали работу ролей;
- Протестировали работу с окружениями stage и prod;
- Проверили работу с Community - ролями, установив роль для nginx;
- Настроили и проверили работу с ключами ansible vault;

ДЗ *

- Подключил Dynamic Inventory через модуль gce.py;
- Расположил модули gce.py и gce.ini в папках stage и prod;
- в папке group_vars переименовал файлы из app и db в tag_reddit-app и tag_reddit-db;
- Внутренний ip - адрес инстанса БД передается из инвентори через переменную вида db_host: "{{ hostvars['reddit-db']['gce_private_ip'] }}";
- Playbook с нужным инвентори можно запустить через ansible.cfg или параметр -i и указанием пути;

ДЗ **

- Установил trytravis, добавил тестовый репозиторий в travis-ci. trytravis запускает тест на сайте, однако в консоли
  постоянно вылетает ошибка по тайм - ауту. Через API некорректно передается время UTC в Ubuntu. Нужно копаться с настройками.  Но даже в таком виде уже можно тестировать без git push и PR.










========================================= HOMEWORK 9  ====================================
Основное ДЗ:

- Создали шаблон изменения конфигурации MongoDB;
- Создали таск для изменения и сделали пробный прогон для инстансов с тэгом db;
- Определили Handler для перезапуска сервиса MongoDB после изменения конфигурации;
- Добавили таск для копирования unit - файла в приложение;
- Добавили handler для перезапуска puma;
- Задание переменной окружения для передачи ip - адреса БД в приложение;
- Применили созданные таски и убедились, что приложение корректно обращается к базе
  удаленном хосте;
- Оценили удобство запуска тестового прогона с парметром --check (аналог terraform plan);
- Еще раз удалил все инстансы, пересоздал их с помощью терраформ (без провижионеров), и
  проверил, что приложение разворачивается только с помощью плейбуков.
- Создали плейбук reddit-app2.ymk, где обозначили уже не один, а 3 сценария для БД, приложения, и деплоя.
- Пересоздали инстансы и проверили корректность выполнения 3-х сценариев в одном плейбуке. 
  Для запуска сценариев использовали только теги;
- Вынесли сценарии в отдельные плейбуки для ДБ, приложения и деплоя. Создали плейбук, который 
  запускает три других плейбука;
- Пересоздали инстансы и проверили выполнение основного плейбука site.yml;
- Заменили ip - адреса вновь созданных инстансов в инвентори;
- Проверили, что приложение доступно по ip инстанса и подключено к базе;

ДЗ со *

- Использовал инвентори - плагин  gce.py, который взял из репо Ansible. По сути нужны два файла - gce.py и
  gce.ini, в котором  прописаны настройки подключения через сервисный аккаунт;
- Можно еще использовать плагин gcp_compute, который есть в последних версиях ansible. Его можно также 
  включить через ansible.cfg;
- В ansible.cfg прописал путь к gce.py, в app_dynamic.yml прописал host "reddit app" и все заработало;
- gce.ini добавил в .gitignore;
- изменения можно посмотреть в коммите 'Dynamic';

ДЗ Packer

- Измениили конфигурационные файлы пакера, вместо скриптов добавили таски ansible;
- Пересоздали образы app и db;
- Пересоздали stage - среду с помощью TF;
- развернули окружение с помощью плейбука site.yml;



========================================= HOMEWORK 8 ====================================
Основное ДЗ:

- Установил Ansible на Linux с помощью pip;
- Создал инвентори для подключения к ВМ созданных в облаке;
- Потестировал работу Ansible с различными модулями;
- Потестировал создание инвентори в формате yaml
- Написал простой плейбук;

При запуске плейбука clone.yml и введении команды 
ansible app -m command -a 'rm -rf ~/reddit' произошло удаление
папки reddit на ВМ. При последующем запуске clone.yml папка была
создана заново, поэтому получили статус changed=1

Задание *
Из обсуждения в Слаке стало понятно, что есть несколько форматов .json - файла. C
одним Ansible может работать напрямую, с другим - нет.
Представлено два варианта (формата) .json - файла: inventory.json и inventory2.json
один можно запустить напрямую через ansible -i, другой вариант можно запустить
через трансляцию yaml посредством скрипта inventory.sh



========================================= HOMEWORK 7 =====================================
Основное ДЗ

- Научились выносить конфигурацию в отдельные модули: app, vpc и db;
- Научились передавать переменные из одних модулей в другие;
- Освоили подключение модулей, создающих инстансы и правила брандмауэра, к главному файлу конфигурации;
- Создали две конфигурации: stage и prod;
- Подключили модуль storage-buckets из реестра модулей.

ДЗ *

- Подключили удаленный backend в storage-bucket для хранения стейта конфигурации;
- Проверили одновременное применение конфигураций - не работает, стейт в бакете блокируется;
- Удалили локальные стейт-файлы и проверили, что Терраформ работает со стейтом в бакете;

ДЗ **

- В модуль app добавили провижионер для загрузки файла deploy.sh и провижионер для загрузки шаблона puma;
- В файл puma передается переменная, содержащая внутренний ip - адрес инстанса с БД;
- Чтобы инстанс с БД принимал внешние подключения к базе, пришлось отредактировать конфиг mongod.conf,
  хотя можно и этот процесс автоматизировать через провижионеры. 


========================================= HOMEWORK 6 =====================================
Основное ДЗ
- Создали конфиг terraform для gcp
- Создали файлы с переменными и проверили, что инстанс формируется при помощи заданных переменных
- Определили input - переменную для приватного ключа
- Определили input - переменную для задания зоны при создании инстанса
- Создали файл terraform.vars.example
дз *

- Добавили ключи appuser1,appuser2,appuser3 в метаданные проекта. Проверили - всё в порядке.
- Добавили через web пользователя appuser-web. После команды terraform apply этот ключ затерся на appuser1.
Вывод: пока terraform позволяет корректно работать только с ключами, заданными в конфигурации самого
terraform.

ДЗ **

в файле lb.tf описаны шаги по созданию балансировщика. Благодаря этому заданию разобрался, какая
цепочка действий в облаке на самом деле нужна при создании балансировщика.
Начал от обратного: создал группу инстансов (нединамическую) -> потом health-check ->
backend service -> url map -> Target proxy -> Global forwarding rule

Балансировка работает корректно, однако подобная схема годится только для тестов доступа, так
как отсутствует репликация между БД виртуалок.
Также при создании нового инстанса придется править конфиги, добавлять IP новой виртуалки в 
output. Это не добавляет автоматизации.

Схему с добавлением новой виртуалки через count также протестировал. Добавл переменную и цикл.






========================================= HOMEWORK 5 =====================================


# Create ubuntu16.json packer GCP image for reddit base installation

# Create immutable.json packer GCP image for reddit full installation

# Define variables in variables.json. Put it to .gitignore

# Fast create VM instance by using gcloud console and reddit-full gcp image


================================================= HOMEWORK 4 ==================================================

testapp_IP = 35.204.153.218
testapp_port = 9292

# Applying startup script when creating instance via gcloud console

gcloud compute instances create test0  --boot-disk-size=10GB   --image-family ubuntu-1604-lts   --image-project=ubuntu-os-cloud   --machine-type=g1-small   --tags puma-server   --restart-on-failure --metadata-from-file startup-script=/home/ilya0/study/scripts/startup_script.sh

# Applying startup script via url

gcloud compute instances create test0  --boot-disk-size=10GB   --image-family ubuntu-1604-lts   --image-project=ubuntu-os-cloud   --machine-type=g1-small   --tags puma-server   --restart-on-failure --metadata startup-script-url=https://www.dropbox.com/s/os1hvjubzpypru0/startup_script.sh

# Applying firewall rules 

gcloud compute firewall-rules create default-puma-server --allow tcp:9292 --source-tags=default --source-ranges=0.0.0.0/0 --description="open reddit app web"


=========================================== HOMEWORK 3===================================================

ilya-adm77_infra
ilya-adm77 Infra repository

bastion_IP = 35.210.243.4 someinternalhost_IP = 10.132.0.3

connect to internal instance via bastion directly
ssh -i ~/.ssh/appuser -t ilya-adm77@35.210.243.4 -A ssh 10.132.0.3

Modify ~/.ssh/config file for someinternalhost direct ssh connect via 'ssh someinternalhost' alias
Host bastion
Hostname 35.210.243.4 User ilya-adm77

Host someinternalhost
User ilya-adm77 ProxyCommand ssh -q bastion nc -q0 10.132.0.3 22





